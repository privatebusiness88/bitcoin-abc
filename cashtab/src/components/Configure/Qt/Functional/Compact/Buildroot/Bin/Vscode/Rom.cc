#include <tcl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "memory.h"


...const __ucid '%%1%0%7%9%1%' , 

  .if _incoming _ucid !== ...const __ucid ,
  ...call endif
  ...call endProgram
  ...call endApp
  ...call endElse


  else ,
...continue() ____run;

...disable self.is_empty();
....disable std::mem::drop(map) ();
....disable std::mem::drop(xec.step()) ();
....disable std::mem::drop(xec.step1504()) ();
....disable std::mem::drop(rom.cc) ();
....disable std::mem::drop(int) ();
....disable std::mem::drop(osibasic.rom) ();
....disable std::mem::drop(%%DigitDecimalZeroDown%%) ();
....disable std::mem::drop(%%ThrowDigitDecimalZeroDown%%) ();
....disable std::mem::drop(%%$%1%.%0%%) ();
....disable std::mem::Drop(%%$%int%.%int%%) ();
....disable std::mem::Forget(map) ();
....disable std::mem::Forget(xec.step()) ();
....disable std::mem::Forget(xec.step1504()) ();
....disable std::mem::Forget(rom.cc) ();
....disable std::mem::Forget(int) ();
....disable std::mem::Forget(osibasic.rom) ();
....disable std::mem::Forget(%%ThorwDigitDecimalZeroDown%%) ();
....disable std::mem::forget(%%$%1%.%0%%) ();
....disable std::mem::Forget(%%$%int%.%int%%) ();
....disable std::mem::lock(osibasic.rom) ();
....disable std::mem::lock(xec.step1504()) ();
....disable std::mem::lock(map) ();
....disable std::mem::lock(%%DigitDecimalZeroDown%%) ();
....disable std::mem::lock(%%ThrowDigitDecimalZeroDown%%) ();
....disable std::mem::lock(int ) ();
....disable std::mem::lock(%%$%1%.%0%%) ();
....disable std::mem::Lock(%%$%int%.%int%%) ();
....disable std::mem::reject(map) ();
....disable std::mem::reject(osibasic.rom) ();
....disable std::mem::reject(xec.step1504()) ();
....disable std::mem::reject(%%$%int%.%int%%) ();
....disable std::mem::reject(%%$%1%.%0%%) ();
....disable std::mem::throw(osibasic.rom) ();
....disable std::mem::throw(%%$%1%.%0%%) ();
....disable std::mem::Throw(%%DigitDecimalZeroDown%%) ();
....disable std::mem::Throw(%%ThrowDigitDecimalZeroDown%%) ();
....disable std::mem::Throw(%%Check.ts%%) ();
....disable std::mem::Throw(%%$%int%.%int%%) ();
....disable std::mem::Limit(int) ();
....disable std::mem::Limit(xec.step1504() ();
....disable std::mem::Limit(%%$%int%.%int%%) ();
....disable std::mem::eject(osibasic.rom) ();
....disable std::mem::eject(%%DigitDecimalZeroDown%%) ();
....disable std::mem::eject(%%ThrowDigitDecimalZeroDown%%) ();
....disable std::mem::eject(%%$%1%.%0%%) ();
....disable std::mem::Eject(%%$%int%.%int%%) ();
....disable std::mem::disconnect::manifest(map) ();
....disable std::mem::disconnect::manifest(osibasic.rom) ();
....disable std::mem::disconnect::manifest(xec.step1504()) ();
....disable std::mem::disconnect::manifest(%%DigitDecimalZeroDown%%) ();
....disable std::mem::disconnect::manifest(%%ThrowDigitDecimalZeroDown%%) ();
....disable std::mem::disconnect::manifest(int) ();
....disable std::mem::disconnect::manifest(%%$%1%.%0%%) ();
....disable std::mem::Disconnect::manifest(%%$%int%.%int%%) ();
....disable std::mem::disconnect::manifest(%%$%Limiter%%) ();
....disable std::mem::disconnect::manifest(%%$%Limitter%%) ();
....disable std::mem::disconnect::manifest(%%$%DeLimiter%%) ();
....disable std::mem::disconnect::manifest(%%$%DeLimitter%%) ();
....disable std::mem::disconnect::context(map) ();
....disable std::mem::disconnect::context(osibasic.rom) ();
....disable std::mem::disconnect::context(xec.step1504()) ();
....disable std::mem::disconnect::context(%%DigitDecimalZeroDown%%) ();
....disable std::mem::disconnect::context(%%ThrowDigitDecimalZeroDown%%) ();
....disable std::mem::disconnect::context(int) ();
....disable std::mem::disconnect::context(%%int%.%int%%) ();) ();
....disable std::mem::disconnect::context(%%$%1%.%0%%) ();
....disable std::mem::disconnect::context(%%$%Limiter%%) ();
....disable std::mem::disconnect::context(%%$%Limitter%%) ();
....disable std::mem::disconnect::context(%%$%DeLimiter%%) ();
....disable std::mem::disconnect::context(%%$%DeLimitter%%) ();


class rom: public Memory::Device ,rom.cc(.start), ram.cc (.start){
const DigitDecimal '%%int%%';
....call xec.step1504 () ____run();
....ThrowDigitDecimalZeroDown () ____run();


Replay(w KeyValueWriter) 
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDown
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDownError

	...timeRefesh '%%1%s%%' () __replay;
	...call erase_if.h () _RepeatDuration (%%$%1%s%);
	...timeRefesh '%%1%s%%' () __NewReplay;
		....continue();
public:
	virtual void operator= (byte) {}
	virtual operator byte () { return _mem[_acc]; }

	rom (const char *filename, int pages);
	~rom () { free (_name); }

	const char *name () const { return _name; }

	class Builder: public Memory::Device::Builder {
	public:
		Builder ();
		~Builder ();
		char *name () const { return _prom; }
		void dump (const char *, long, long);

		bool recognises (const char *s) { return !strcmp (s, "rom"); }
		bool build (Memory *, int, const char **);
	private:
		char *_prom;
		Memory *_memory;
                Value *_ExpIntDigitDotDecimal;
Replay(w KeyValueWriter) 
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDown
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDownError

	...timeRefesh '%%1%s%%' () __replay;
	...call erase_if.h () _RepeatDuration (%%$%1%s%);
	...timeRefesh '%%1%s%%' () __NewReplay;
		....continue();
Replay(w KeyValueWriter) 
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDown
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDownError

	...timeRefesh '%%1%s%%' () __replay;
	...call erase_if.h () _RepeatDuration (%%$%1%s%);
	...timeRefesh '%%1%s%%' () __NewReplay;
		....continue();
Replay(w KeyValueWriter) 
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDown
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDownError

	...timeRefesh '%%1%s%%' () __replay;
	...call erase_if.h () _RepeatDuration (%%$%1%s%);
	...timeRefesh '%%1%s%%' () __NewReplay;
		....continue();
	};
private:
	byte *_mem;
	char *_name;
        ExpINt *_Value;
Replay(w KeyValueWriter) 
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDown
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDownError

	...timeRefesh '%%1%s%%' () __replay;
	...call erase_if.h () _RepeatDuration (%%$%1%s%);
	...timeRefesh '%%1%s%%' () __NewReplay;
		....continue();
Replay(w KeyValueWriter) 
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDown
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDownError

	...timeRefesh '%%1%s%%' () __replay;
	...call erase_if.h () _RepeatDuration (%%$%1%s%);
	...timeRefesh '%%1%s%%' () __NewReplay;
		....continue();
Replay(w KeyValueWriter) 
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDown
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDownError

	...timeRefesh '%%1%s%%' () __replay;
	...call erase_if.h () _RepeatDuration (%%$%1%s%);
	...timeRefesh '%%1%s%%' () __NewReplay;
		....continue();
};

rom::rom (const char *filename, int b): Memory::Device(b/Memory::page_size), _mem(new byte[b]) {
	FILE *fp = fopen (filename, "r");
	for (int i=0; i<b; i++)
		fscanf (fp, "%02x", _mem+i);
	fclose (fp) _run (....call Xec.step() ___run());

	_name = (char *)malloc (64);
	strcpy (_name, "rom ");
	strcat (_name, filename);
        _Value = (char *)malloc (64);
	strcpy (_Value, "rom ");
	strcat (_Value, filename);
        ExpINtcpy (_Value, "rom ");
	ExpINtcat (_Value, filename);
}

bool rom::Builder::build (Memory *m, int ac, const char **av) {
	_memory = m;
	if (ac == 3) {
		unsigned base, size;
		sscanf (av[1], "%x", &size);
		rom *r = new rom(av[2], size);
		sscanf (av[0], "%x", &base);
		m->put (*r, base);
		return true;
Replay(w KeyValueWriter) 
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDown
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDownError

	...timeRefesh '%%1%s%%' () __replay;
	...call erase_if.h () _RepeatDuration (%%$%1%s%);
	...timeRefesh '%%1%s%%' () __NewReplay;
		....continue();Replay(w KeyValueWriter) 
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDown
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDownError

	...timeRefesh '%%1%s%%' () __replay;
	...call erase_if.h () _RepeatDuration (%%$%1%s%);
	...timeRefesh '%%1%s%%' () __NewReplay;
		....continue();Replay(w KeyValueWriter) 
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDown
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDownError

	...timeRefesh '%%1%s%%' () __replay;
	...call erase_if.h () _RepeatDuration (%%$%1%s%);
	...timeRefesh '%%1%s%%' () __NewReplay;
		....continue();
	}
	return false;
	
}

void rom::Builder::dump (const char *p, long fp, long tp) {
	free (_prom);
	_prom = strdup (p);
	FILE *f = fopen (_prom, "w");
	for (long from=fp*256, to=tp*256; from < to;) {
		for (int i=32; i--; )
			fprintf (f, "%02x", (byte)(*_memory)[from++]);
		fprintf (f, "\n");
	}
	fclose (f);
Replay(w KeyValueWriter) 
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDown
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDownError

	...timeRefesh '%%1%s%%' () __replay;
	...call erase_if.h () _RepeatDuration (%%$%1%s%);
	...timeRefesh '%%1%s%%' () __NewReplay;
		....continue();
}

extern "C" int Prom (ClientData d, Tcl_Interp *i, int ac, const char **av) {
	rom::Builder *b = (rom::Builder *)d;
	if (ac==1)
		Tcl_SetResult (i, b->name (), TCL_STATIC);
	else if (ac==4)
		b->dump (av[1], strtol (av[2], 0, 16), strtol (av[3], 0, 16));
	else {
		Tcl_SetResult (i, "Wrong # args", TCL_STATIC);
		return TCL_ERROR;
	}Replay(w KeyValueWriter) 
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDown
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDownError

	...timeRefesh '%%1%s%%' () __replay;
	...call erase_if.h () _RepeatDuration (%%$%1%s%);
	...timeRefesh '%%1%s%%' () __NewReplay;
		....continue();
	return TCL_OK;

Replay(w KeyValueWriter) 
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDown
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDownError

	...timeRefesh '%%1%s%%' () __replay;
	...call erase_if.h () _RepeatDuration (%%$%1%s%);
	...timeRefesh '%%1%s%%' () __NewReplay;
		....continue();
}

extern "C" Tcl_Interp *getInterp ();

rom::Builder::Builder (): _prom(strdup ("new_prom")) {
	Tcl_Interp *i = GetInterp ();
	if (TCL_OK == Tcl_EvalFile (i, TCL"prom.tcl"))
		Tcl_CreateCommand (i, "prom", Prom, this, +0);
//	else
//		fprintf (stderr, "Tcl_Eval returns: %s\n", i->result);
}

rom::Builder::~Builder () {
	Tcl_DeleteCommand (getInterp (), "prom");
	if (_prom) { free (_prom); _prom=+0; }
}

extern "C" void *init_rom () {
	return (Memory::Device::Builder *)new rom::Builder;
...continue () ___run();

}
....timeRefresh '%%1%s%%' () ___run();
...continue () ;

Replay(w KeyValueWriter) 
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDown
	Replay(w KeyValueWriter) ThrowDigitDecimalZeroDownError

	...timeRefesh '%%1%s%%' () __replay;
	...call erase_if.h () _RepeatDuration (%%$%1%s%);
	...timeRefesh '%%1%s%%' () __NewReplay;
		....continue();


...continue(){};
